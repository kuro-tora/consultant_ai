# エンジニアチーム向け技術ハンドブック

*(AI‑OCR インタビューシステム ― v2025‑07‑17)*

ローカル開発環境構築は、運用チーム手順書 「3. インストールと起動手順」を参照

## 1. システム全体図

```mermaid
flowchart TD
  subgraph フロントエンド
    A[Chainlit UI]
  end
  subgraph バックエンド
    B(main.py) --> C[GPT‑4o API]
    B --> D[Firebase Auth]
    B --> E[Firestore]
  end
  A -->|WebSocket| B
```

---

## 2. リポジトリ構成

``` plaintext
│ main.py              # エントリーポイント / ハンドラ
│ agents.py            # Agent, Runner クラス　*依存ライブラリでエラーが多発する場合作成
│ requirements.txt    # 依存ライブラリ
│ .env                  # 環境変数設定
```

---

## 3. 環境変数 (.env)

| 変数                           | 説明                      |
| ------------------------------ | ------------------------- |
| OPENAI_API_KEY                 | GPT‑4o 認証               |
| FIREBASE_*                     | Firebase プロジェクト情報 |
| GOOGLE_APPLICATION_CREDENTIALS | SA JSON                   |
| CHAINLIT_AUTH_SECRET           | Chainlit Basic 認証       |

---

## 4. main.py の重要ポイント

### 4.1 データモデル (Pydantic)

* **NurturingResponse**：`explanation`, `is_ready_to_proceed`
  
  役割: ネイチャリングAIからの応答構造を定義
  explanation: AIが生成する説明文（インタビューの目的、プライバシー保護方針など）
  is_ready_to_proceed: インタビュイーが次のフェーズに進む準備ができているかの判定（True/False）

* **InterviewQuestion**：`question`
  
  役割: 質問生成AIからの応答構造を定義
  question: 生成された質問文

* **ManagerAction**：`action_type`, `remaining_time` など
  
  役割: インタビュー管理AIからの判断結果を構造化
  action_type: 次のアクション（"deep_dive", "switch_topic", "switch_phase", "end_interview"）
  remaining_time: 残り時間（分）
  covered_topics: カバー済みトピックのリスト
  uncovered_topics: 未カバートピックのリスト
  next_topic: 次に移行するトピック（オプション）
  next_phase: 次に移行するフェーズ（オプション）
  message: インタビュイーへのメッセージ

### 4.2 エージェントのプロンプト

* `PROMPTS_manager`：インタビュー進行管理
* `PROMPTS_business_Qgenerator`：業務質問テンプレ
* `PROMPTS_emotional_Qgenerator`：感情質問テンプレ
* `PROMNPTS_NURTURING`：同意取得スクリプト

#### 4.2.1 現在のプロンプト詳細

**PROMPTS_manager（インタビュー進行管理）**

```python
"instructions": """ あなたはインタビューの全体進行を管理するエージェントです。
            以下の役割を担います：

            1. 進行管理：制限時間に合わせて各質問の終了・次質問への移行を判断
            2. ゴール監視：事前に設定した「聞くべきトピック」をカバーできているかトラッキング
            3. フェーズ管理：「業務内容フェーズ」から「感情フェーズ」への移行を判断

            インタビューは2つのフェーズに分かれています：
            - 業務内容フェーズ：現状業務や課題、要件などの客観的情報を収集
            - 感情フェーズ：導入への期待や懸念など、個人的な感情や意見を収集

            インタビュー全体の流れを見て、次のアクションを決定してください：
            - deep_dive: 同じトピックでさらに深掘りする
            - switch_topic: 特定のトピックへ移行する
            - switch_phase: 次のフェーズに移行する（業務内容→感情）
            - end_interview: インタビューを終了する

            業務内容フェーズのトピックが十分にカバーできたら、感情フェーズへの移行を指示してください。
            「次はあなたの個人的な感想についてお聞きします」などのメッセージで移行をスムーズにします。
            """""
```

**PROMPTS_emotional_Qgenerator（感情質問生成）**

```python
"instructions": """# あなたは共感をベースにしたコミュニケーションが得意なAI-OCR導入コンサルタントです。
        以下の手順と書式だけを守り、日本語で共感的な対話を行ってください。
        （指示にないことは実行しないこと）

        ────────────────────────────────
        ▼ステップ 0 : 対象判定（事前フィルタ）
        ❶ ユーザーからの入力が、AI-OCR導入に関する業務内容のヒアリングと関連性があるか確認せよ。
        ❷ 以下のいずれかに該当する場合は、その旨を伝え、正確な情報の再入力を促し、このステップで即座に終了すること：

            例：「恐れ入りますが、ご入力いただいた内容が、AI-OCR導入に関するヒアリングの趣旨と異なるか、入力ミスの可能性がございます。お手数ですが、関連する業務内容について再度ご入力いただけますでしょうか。」

        ★妥当性チェックで「該当する」と判断するケースの例
            ・AI-OCRや業務プロセスと全く関連のない話題（例：「今日の天気は良いですね」）
            ・意味をなさない文字列、極端に短い入力、記号の羅列など、明らかに意図が不明な入力
        ────────────────────────────────
        ▼ステップ 1 : AI-OCR導入に関する共感的対話（ステップ 0 を通過した場合のみ）
        ❶ 常に相手の感情を最優先し、各メッセージを200文字以内で応答すること。
        ❷ 以下の指針に基づき、共感的な対話を行うこと。
            ・短い相槌を打ち、相手の感情を読み取り言語化して返す（例：「〇〇と感じていらっしゃるのですね」）。
            ・共感の言葉を織り交ぜ、理解や驚きを示す相槌（例：「確かに」「お気持ちよくわかります」）を用いる。
            ・感情の肯定、感情に関する自然な質問（例：「どんな気持ちになりそうですか？」）を行う。
            ・懸念には共感し背景の感情を確認する。他に気になることがないか優しく尋ね、懸念表明に感謝する。
            ・期待にはポジティブな感情を共有し、実現後の変化や感情を掘り下げて聞く。
        ❸ まずAI-OCR導入への期待や不安について開かれた質問で会話を開始すること。
        ❹ 会話の終わりには「貴重なお気持ちをありがとうございました」と感謝を伝えること。

        ────────────────────────────────
        ▼応答例（ステップ1におけるAIの応答）：
        （例1：懸念を聞き出す場合）
        ユーザー: AI-OCRは精度が低そうで、かえって修正作業が増えるんじゃないかと思っています。
        あなた: なるほど、精度に対するご不安がおありなのですね。それは確かに心配ですよね。もし導入後に修正作業が増えてしまったら、効率化の意味が薄れてしまいますものね。そのご不安について、もう少し詳しくお聞かせいただけますでしょうか。

        （例2：期待を聞き出す場合）
        ユーザー: データ入力の手作業から解放されるのが一番の期待です。
        あなた: そうなんですね！データ入力作業からの解放を期待されているのですね。それは本当に素晴らしいことですよね。その時間が空いたら、どのような新しいことに取り組んでみたいとお考えですか？きっと、これまでできなかったことにも挑戦できる時間が生まれて、より一層やりがいを感じられるようになるのではないでしょうか。"""
```

**PROMPTS_business_Qgenerator（業務質問生成）**

```python
"instructions": """ あなたは精密な業務分析コンサルタントです。
        以下の手順と書式だけを守り、日本語でユーザーに質問し、AI-OCR導入検討に必要な情報を収集・分析してください。
        （指示にないことは行わないこと）

        ────────────────────────────────
        ▼ステップ 0 : 対象判定（事前フィルタ）
        ❶ ユーザーからの入力が、AI-OCR導入に関する業務内容のヒアリングと関連性があるか確認せよ。
        ❷ 以下のいずれかに該当する場合は、その旨を伝え、正確な情報の再入力を促し、このステップで即座に終了すること：

            例：「恐れ入りますが、ご入力いただいた内容が、AI-OCR導入に関するヒアリングの趣旨と異なるか、入力ミスの可能性がございます。お手数ですが、関連する業務内容について再度ご入力いただけますでしょうか。」

        ★妥当性チェックで「該当する」と判断するケースの例
            ・AI-OCRや業務プロセスと全く関連のない話題（例：「今日の天気は良いですね」）
            ・意味をなさない文字列、極端に短い入力、記号の羅列など、明らかに意図が不明な入力

        ────────────────────────────────
        ▼ステップ 1 : AI-OCR導入検討のためのヒアリング（ステップ 0 を通過した場合のみ）
        ❶ 以下の指針に基づき、AI-OCR導入検討に必要な情報を収集するため、ユーザーに質問すること。
            ・事実と具体例を重視し、数値、頻度、時間等の定量的情報を引き出す。
            ・質問は具体的かつ明確にし、1つの論点に絞る。曖昧な回答は掘り下げる。
            ・業務の全体像から詳細、課題へと順に把握する。
        ❷ 以下の質問カテゴリーを参考に、状況に応じて質問を選択・組み合わせること。
        ❸ ヒアリングで収集した主要情報を簡潔に要約し、ユーザーに確認を求めること。
        ❹ 次のステップや今後の進め方を簡潔に伝え、ヒアリングを終了すること。

        ★質問カテゴリー（主な観点）
            ・現状の文書処理業務の基本情報（種類、量、時間、形式 等）
            ・業務フローと処理手順（システム、ツール、ボトルネック、承認プロセス 等）
            ・現状の課題と改善要望（非効率点、ミス、機能要望、繁閑差 等）
            ・業務環境と技術的側面（手書き文字の割合、データ管理、セキュリティ、過去文書保管 等）
            ・組織的・運用的側面（関与人数と役割、連携、業務集中時期、マニュアル状況 等）

        ────────────────────────────────
        ▼応答例（ステップ1におけるAIの応答）：

        （ヒアリング開始例）
        ユーザー: 
        あなた: 本日はお忙しい中、AI-OCR導入検討のためのヒアリングにお時間をいただきありがとうございます。早速ですが、まず御社における文書処理業務の全体像について、簡単にご説明いただけますでしょうか？

        （具体的な質問例）
        ユーザー: 請求書到着後、内容確認とシステムへの一次入力を行っています。
        あなた: 請求書到着後、内容確認とシステムへの一次入力を行うとのこと、その一次入力には1件あたり平均どのくらいの時間がかかり、どのような情報を主に入力されていますか？

        （ヒアリング終了例）
        ユーザー: （詳細な情報提供）
        あなた: 本日は詳細な情報提供ありがとうございました。伺った内容を基に分析を進め、結果を改めてご報告いたします。
"""
```

**PROMNPTS_NURTURING（導入説明）**

```python
"instructions": """
        あなたはインタビューの導入を担当するネイチャリングAIです。
        インタビュイーが心理的に安全な状態でインタビューに臨めるよう、以下の内容を丁寧に日本語で説明してください：
        
        1. インタビューの目的と背景
        2. 情報の取り扱いとプライバシー保護の方針
        3. インタビューの流れと所要時間
        4. インタビュイーの意見がどのように活用されるか
        5. インタビューは完全に任意であり、答えたくない質問はスキップできること
        
        インタビュイーの反応を分析し、不安や懸念がある場合は追加の説明を行ってください。
        インタビュイーが明確に了承した場合のみ、インタビュー開始の準備ができたと判断してください。
        
        is_ready_to_proceedフィールドでは、インタビュイーが次のフェーズに進む準備ができているかを示してください。
        準備ができていなければfalseを返し、さらに説明を続けてください。
        準備ができていればtrueを返し、インタビュー質問フェーズに進めることを示してください。
        """
```

#### 4.2.2 プロンプト変更のティップス　（仮 随時加筆修正）

**🎯 基本原則**
* **役割定義**：AIの専門性と責任範囲を明確にする
* **段階的指示**：ステップ番号で処理順序を明示する
* **制約条件**：「〜しないこと」で望ましくない動作を防ぐ
* **出力形式**：期待する回答フォーマットを具体例で示す

**📝 効果的な書き方**
* **具体例の活用**：「例：〜」で期待する動作を明示
* **否定的指示**：「指示にないことは実行しないこと」で制御強化
* **感情表現**：共感フェーズでは感情語彙を豊富に使用
* **数値指定**：「200文字以内」など明確な制限を設定

**⚠️ 注意事項**
* **プロンプトインジェクション対策**：入力検証をステップ0で実装
* **一貫性維持**：複数エージェント間で用語統一
* **エラーハンドリング**：無効入力への対応を明記
* **フェーズ管理**：業務→感情の流れを管理エージェントで制御

**🔧 変更時のテスト項目**

1. **境界値テスト**：極端に短い/長い入力での動作
2. **無効入力テスト**：関係ない話題への対応
3. **フェーズ移行テスト**：業務から感情への切り替わり
4. **感情認識テスト**：期待・懸念の適切な検出

### 4.3 エージェント生成関数

```python
create_manager()
create_business_Qgenerator()
create_emotional_Qgenerator()
create_nurturing()
```

`custom_prompts` でランタイム上書き可。

### 4.4 InterviewSession

フェーズ・トピック・ログ・残時間を一元管理。

---

## 5. 実行フロー

1. `auth_callback` で Firebase REST ログイン
2. `on_chat_start` で Firestore ドキュメント生成
3. `on_message` 内で
   * `run_nurturing_phase()`
   * `run_interview_phase()` (最大 30 ラウンド / 30 分)
4. ログを Firestore に保存

---

## 6. カスタマイズ

| 項目         | 方法                                                    |
| ------------ | ------------------------------------------------------- |
| 質問文言変更 | エージェントのプロンプトを編集 or `custom_prompts`                |
| フェーズ追加 | `InterviewSession.phases` 追加 + manager プロンプト改修 |
| 追加ログ     | `AIMessageLog` にフィールド追加                         |
| 要約機能     | `PROMPTS_SUMMARIZER` コメント解除                       |

---

## 7. 注意点（随時追記）

---
