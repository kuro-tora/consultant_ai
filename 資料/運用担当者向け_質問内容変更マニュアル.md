# 運用担当者向け 質問内容変更マニュアル

本マニュアルは、インタビューフローの「質問内容（カテゴリ・文面・ルール）」を運用で変更するための手順をまとめたものです。コードのロジックは触らず、プロンプト（指示文）の編集のみで運用変更できる構成になっています。

変更日: 2025-09-03

---

## 1. 対象と前提

- 対象: 業務質問生成AI（business）、感情質問生成AI（emotional）、ネイチャリングAI（導入説明）
- 変更対象の場所: `main.py` 内のプロンプト定義ブロック
  - `PROMPTS_business_Qgenerator`（業務フェーズの質問）
  - `PROMPTS_emotional_Qgenerator`（感情フェーズの質問）
  - `PROMPTS_manager`（進行管理ポリシー）
  - `PROMNPTS_NURTURING`（導入説明/同意取得）
- 変更反映の前提: 編集後、Chainlit のセッションを再起動（面談を新規開始）してください。
- 変更反映の前提: 編集後、Chainlit のセッションを再起動（面談を新規開始）してください。
- 行番号の注意: 本書の行番号は 2025-09-03 時点の `main.py` を基準としています。将来の変更でずれる場合は、末尾の検索アンカー（12章）を使って該当箇所を特定してください。

---

## 2. 変更できるもの一覧

- 業務フェーズのカテゴリ一覧（順序・追加・削除）
- 感情フェーズのカテゴリ一覧（順序・追加・削除、文字数制約）
- 質問スタイルと出力ルール（1行出力、先頭に `[カテゴリ名]`、重複回避、深掘り回数）
- フェーズ完了時の `[完了確認]` 文言
- 進行管理ポリシー（原則 `next_question`、`deep_dive` は各カテゴリ1回、切替条件 など）
- 導入説明（ネイチャリング）の本文
- 会社別の個別トピック（Firestore ドキュメント）

---

## 3. 実編集手順（業務・感情のカテゴリ）

### 3.1 業務フェーズのカテゴリを変更

- 該当箇所: `main.py` の `PROMPTS_business_Qgenerator` ブロック（`BEGIN_CATEGORIES` ～ `END_CATEGORIES`）
- 例: `main.py:124` 付近（エディタで `BEGIN_CATEGORIES` を検索してもOK）
- 現行行番号: `main.py:132-142`
- 操作:
  - 追加: `BEGIN_CATEGORIES` と `END_CATEGORIES` の間に1行1カテゴリで追記
  - 削除: 行を削除
  - 並び替え: 行の順序を入れ替え（質問は上から順に未収集カテゴリを収集します）
- 注意:
  - 各行は先頭にハイフン+半角スペース（例: `- 使用技術`）
  - カテゴリ名は重複させない（重複すると重複回避ロジックに影響）

### 3.2 感情フェーズのカテゴリを変更

- 該当箇所: `main.py` の `PROMPTS_emotional_Qgenerator` ブロック（`BEGIN_CATEGORIES` ～ `END_CATEGORIES`）
- 例: `main.py:173` 付近
- 現行行番号: `main.py:181-187`
- 操作は 3.1 と同様
- 文字数制約の変更（デフォルト200文字以内）
  - `3) 質問スタイル` の文言を編集（例: `200文字以内` → `150文字以内` など）
  - 現行行番号（感情の「200文字以内」記載）: `main.py:202`

---

## 4. 出力ルール/完了確認の編集

### 4.1 出力ルール（厳守事項）

- 場所（業務/感情とも）:
  - `2) 出力形式（厳守）` セクション
- 現行行番号:
  - 業務: `main.py:151-154`
  - 感情: `main.py:196-199`
- 原則:
  - 「質問文のみを1行で出力」
  - 先頭に必ず `[カテゴリ名]` を付ける（例: `[直近の実績] ...`）
  - 前置き/要約/装飾/箇条書き/メタ説明は出力しない
- ここを削ると回答が長文化/装飾化し、UIやログ整形が崩れます。変更は最小限にしてください。

### 4.2 `[完了確認]` の文言変更

- 場所（業務）: `5) 終了シグナル` の行（例: `main.py:163` 付近）
- 場所（感情）: 同セクション（例: `main.py:209` 付近）
- 現行行番号:
  - 業務（セクション全体）: `main.py:163-166`（文言は `main.py:165`）
  - 感情（セクション全体）: `main.py:209-211`（文言は `main.py:211`）
- 変更してよい部分:
  - 日本語の本文（表現の微調整）。ただし先頭の `[完了確認]` タグは必須です。

---

## 5. 進行管理ポリシー（必要時のみ調整）

- 場所: `main.py` の `PROMPTS_manager`（例: `main.py:94` 付近）
- 現行行番号: `main.py:94-122`
- 現行方針:
  - `next_question` を原則優先（カテゴリの選定は質問生成AIが担当）
  - `deep_dive` は各カテゴリ最大1回（回答が曖昧/不足時）
  - フェーズ完了は `[完了確認]` で合意が得られたら切替/終了
- このポリシーを緩める/強める場合は、ここの文言を編集してください。運用影響が大きいため、改定前後で必ず動作確認を行ってください。

---

## 6. 導入説明（ネイチャリング）の編集

- 場所: `main.py` の `PROMNPTS_NURTURING`（例: `main.py:235` 付近）
- 現行行番号: `main.py:235-254`
- 説明項目（目的/プライバシー/所要時間/活用/任意性）を自社用に編集可能
- 重要: 出力スキーマは `NurturingResponse`（`explanation`, `is_ready_to_proceed`）に準拠。本文を変えても、最後に「次フェーズへ進めるか」を必ず返す設計を維持してください。

---

## 7. 会社別トピック（Firestore）の設定（任意）

- 面談セッションは会社ごとのトピックを Firestore から読み込み可能です。
- 参照関数（`main.py`）:
  - `get_business_topic(company_email)` → ドキュメント名: `業務内容トピック`、フィールド: `業務内容トピック`
  - `get_emotional_topic(company_email)` → ドキュメント名: `感情トピック`、フィールド: `感情トピック`
- 現行行番号（参照関数）:
  - `get_business_topic`: `main.py:543-550`
  - `get_emotional_topic`: `main.py:552-559`
- 推奨スキーマ（Firebase Console で設定）:
  - コレクション: `<company_email>`
  - ドキュメント: `業務内容トピック` にフィールド `業務内容トピック`: Array<string>
  - ドキュメント: `感情トピック` にフィールド `感情トピック`: Array<string>
- 例:
  - `業務内容トピック`: `["直近の実績", "人材種別", "アピールポイント"]`
  - `感情トピック`: `["新しい業務への期待", "理想の働き方"]`
- 注意: ここは「カテゴリ定義」ではなく、「運用上のトピックの優先/表示」に活用されます。カテゴリ名と矛盾しないようにしてください。

---

## 8. 変更後の動作確認（チェックリスト）

1) 面談を新規開始し、最初の質問に `[カテゴリ名]` が付くか
2) 2問目以降で同カテゴリの重複質問が出ないか
3) あえて曖昧に答えて `deep_dive` が1回だけ発生するか
4) 全カテゴリを1巡後、`[完了確認]` の確認質問が出るか
5) 感情フェーズでも同様の動作か（文字数制約が効いているか）
6) Firestore への保存（`<company_email>/<email>`）で `nurturing` と `interview` が記録されるか（保存処理実装: `main.py:1019-1020`）

---

## 9. 運用のコツ / よくある質問

- 出力が長文化/装飾される
  - `2) 出力形式（厳守）` の文言が弱まっていないか確認。前置き・箇条書き禁止を残す。
- 同じ論点の再質問が出る
  - カテゴリ名の重複/表記ゆれがないか確認。カテゴリの粒度を調整。
- `[完了確認]` が出ない/進行が意図通りでない
  - `PROMPTS_manager` の方針文が崩れていないか確認。`next_question` 優先を維持する。
- 途中でカテゴリ名を変更してよい？
  - 進行中セッションには影響するため、面談の合間（無セッション時）に実施する。
- 日本語/記号の注意
  - `[カテゴリ名]` の角括弧は半角 `[` `]` を推奨。カテゴリ名の前後に余計な空白を入れない。

---

## 10. 変更管理（推奨フロー）

- ブランチを切って編集 → 動作確認 → レビュー → `main` へ反映
- コミット例:
  - `fix(prompts): [業務] カテゴリに「使用技術」を追加`
  - `chore(nurturing): 所要時間の説明を60分→45分に修正`

---

## 11. 既知の注意事項（技術）

- ログ整形の改行タイポ
  - `main.py` のインタビュー全文生成で `"Q{i+1}: {q}n"` という箇所があります。正しくは `"\n"` です。表示乱れがある場合は修正してください（開発担当に依頼可）。該当行: `main.py:565`
- 実行結果のアンパック
  - `run_ai_with_logging` は `(result, log)` を返します。質問生成側はすでに修正済みですが、将来の変更時は戻り値の取り扱いに注意。定義位置: `main.py:384-418`

---

## 12. 参考（検索アンカー）

- 業務カテゴリ: `PROMPTS_business_Qgenerator` / `BEGIN_CATEGORIES`
- 感情カテゴリ: `PROMPTS_emotional_Qgenerator` / `BEGIN_CATEGORIES`
- 完了確認: `5) 終了シグナル` / `[完了確認]`
- 進行管理: `PROMPTS_manager` / `next_question` / `deep_dive`
- 導入説明: `PROMNPTS_NURTURING`

以上です。編集後は必ず新規セッションで一通りの流れ（業務→感情→終了）を確認してください。
